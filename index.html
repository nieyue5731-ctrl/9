<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="description" content="Terraria Ultra - Aesthetic Edition - A beautiful 2D sandbox game">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#1a1a2e" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>✨</text></svg>" />
    <title>✨ Terraria Ultra - Aesthetic Edition ✨</title>

    <!-- ═══════════════════ CSS Modules ═══════════════════ -->
    <link rel="stylesheet" href="css/variables.css" />
    <link rel="stylesheet" href="css/effects.css" />
    <link rel="stylesheet" href="css/hud.css" />
    <link rel="stylesheet" href="css/minimap.css" />
    <link rel="stylesheet" href="css/mining.css" />
    <link rel="stylesheet" href="css/crafting.css" />
    <link rel="stylesheet" href="css/inventory.css" />
    <link rel="stylesheet" href="css/loading.css" />
    <link rel="stylesheet" href="css/mobile.css" />
    <link rel="stylesheet" href="css/overlays.css" />
    <link rel="stylesheet" href="css/responsive.css" />
    <link rel="stylesheet" href="css/performance.css" />

    <!-- ═══════════════════ Core Infrastructure (must load first) ═══════════════════ -->
    <script src="js/core/defensive.js"></script>
    <script src="js/core/event-manager.js"></script>
    <script src="js/performance/particle-pool.js"></script>
    <script src="js/performance/perf-monitor-bridge.js"></script>
</head>

<body>
    <canvas id="game"></canvas>
    <!-- 环境粒子 -->
    <div id="ambient-particles"></div>
    <!-- 加载界面 -->
    <div id="loading">
        <div class="loading-particles"></div>
        <div class="loading-content">
            <h1>✨ TERRARIA ULTRA ✨</h1>
            <p class="subtitle">Aesthetic Edition</p>
            <div class="progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-fill" id="load-progress"></div>
            </div>
            <div class="status" id="load-status" aria-live="polite">初始化魔法引擎...</div>
        </div>
    </div>
    <!-- 横屏提示 -->
    <div id="rotate-hint">
        <div class="icon">📱</div>
        <p>请横屏游玩以获得最佳体验</p>
    </div>
    <!-- 合成界面 -->
    <div id="crafting-overlay">
        <div id="crafting-panel">
            <div class="close-btn" id="craft-close">✕</div>
            <div class="craft-list-container">
                <div class="craft-header">
                    <span>🔨 制造</span>
                </div>
                <div class="craft-grid" id="craft-grid">
                    <!-- 动态生成 -->
                </div>
            </div>
            <div class="craft-details">
                <div class="preview-box" id="craft-preview"></div>
                <div class="item-title" id="craft-title">选择物品</div>
                <div class="item-desc" id="craft-desc">点击左侧列表查看配方</div>
                <div class="ingredients-list" id="craft-ingredients">
                    <!-- 动态生成 -->
                </div>
                <button class="craft-btn" disabled="" id="craft-action-btn">制造</button>
            </div>
        </div>
    </div>
    <!-- 背包界面 -->
    <div aria-hidden="true" id="inventory-overlay">
        <div aria-label="背包" id="inventory-panel" role="dialog">
            <div class="inv-close-btn" id="inv-close" title="关闭 (Esc)">✕</div>
            <div class="inv-left">
                <div class="inv-topbar">
                    <div class="inv-title">🎒 背包</div>
                    <div class="inv-capacity">
                        <span class="inv-capacity-text" id="inv-capacity-text">0/36</span>
                        <div class="inv-capacity-bar">
                            <div class="fill" id="inv-capacity-fill"></div>
                        </div>
                    </div>
                </div>
                <div class="inv-section">
                    <div class="inv-section-label">快捷栏 <span style="opacity:.6">(1-9)</span></div>
                    <div class="inv-grid" id="inv-hotbar-grid"></div>
                </div>
                <div class="inv-section">
                    <div class="inv-section-label">背包</div>
                    <div class="inv-grid" id="inv-backpack-grid"></div>
                </div>
            </div>
            <div class="inv-right">
                <div class="inv-preview-box" id="inv-preview"></div>
                <div class="inv-item-name" id="inv-item-name">未选择</div>
                <div class="inv-item-meta" id="inv-item-meta"></div>
                <div class="inv-item-desc" id="inv-item-desc">点击格子查看，或拖拽/点击交换。</div>
                <div class="inv-action-row">
                    <button class="inv-btn primary" id="inv-sort">🧹 整理</button>
                    <button class="inv-btn" id="inv-to-hotbar">↔ 放入快捷栏</button>
                    <button class="inv-btn" id="inv-put-back">↩ 放回</button>
                    <button class="inv-btn danger" id="inv-drop">🗑 丢弃</button>
                </div>
                <div class="inv-hints">
                    <div><kbd>左键</kbd> 拿起/放下　<kbd>右键</kbd> 拆分/放 1 个</div>
                    <div><kbd>Shift</kbd>+<kbd>点击</kbd> 快速移动　<kbd>B</kbd>/<kbd>I</kbd> 打开背包　<kbd>Esc</kbd> 关闭</div>
                </div>
            </div>
        </div>
        <!-- 光标物品 -->
        <div aria-hidden="true" id="inv-held"></div>
    </div>
    <!-- UX+：暂停 / 设置 / 存档 -->
    <div aria-hidden="true" class="ux-overlay" id="pause-overlay">
        <div class="ux-panel">
            <div class="ux-title">
                <h2>⏸ 已暂停</h2>
                <button aria-label="关闭" class="ux-close" id="pause-close">✕</button>
            </div>
            <div class="ux-grid">
                <div class="ux-row">
                    <label>
                        <b>提示</b>
                        <small>暂停时游戏不会更新；你仍可查看界面并调整设置。</small>
                    </label>
                    <span> </span>
                </div>
            </div>
            <div class="ux-actions">
                <button class="ux-action" id="pause-newworld">🧹 新世界</button>
                <button class="ux-action" id="pause-save">💾 保存</button>
                <button class="ux-action" id="pause-fullscreen">🖥 全屏</button>
                <button class="ux-action primary" id="pause-resume">▶ 继续</button>
            </div>
        </div>
    </div>
    <div aria-hidden="true" class="ux-overlay" id="settings-overlay">
        <div class="ux-panel">
            <div class="ux-title">
                <h2>⚙️ 设置</h2>
                <button aria-label="关闭" class="ux-close" id="settings-close">✕</button>
            </div>
            <div class="ux-grid" id="settings-grid">
                <!-- 动态生成 -->
            </div>
            <div class="ux-actions">
                <button class="ux-action" id="settings-reset">🔄 恢复默认</button>
                <button class="ux-action primary" id="settings-apply">✅ 应用</button>
            </div>
        </div>
    </div>
    <div aria-hidden="true" class="ux-overlay" id="save-overlay">
        <div class="ux-panel">
            <div class="ux-title">
                <h2>💾 存档</h2>
                <button aria-label="关闭" class="ux-close" id="save-close">✕</button>
            </div>
            <div class="ux-grid">
                <div class="ux-row">
                    <label><b>存档信息</b><small id="save-info">正在检查…</small></label>
                    <span></span>
                </div>
            </div>
            <div class="ux-actions">
                <button class="ux-action" id="save-continue">▶ 继续</button>
                <button class="ux-action" id="save-new">🧹 新世界</button>
                <button class="ux-action primary" id="save-cancel">✕</button>
            </div>
        </div>
    </div>
    <!-- HUD -->
    <div id="ui">
        <div id="stats">
            <div class="stat-bar"><span class="icon">❤️</span><div class="bar"><div class="fill" id="health-fill"></div><span class="value" id="health-text"></span></div></div>
            <div class="stat-bar"><span class="icon">💎</span><div class="bar"><div class="fill" id="mana-fill"></div><span class="value" id="mana-text"></span></div></div>
        </div>
        <div id="hotbar">
            <!-- 动态生成 -->
        </div>
        <div id="fps" style="display:none;position:fixed;top:4px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,0.5);font-size:11px;z-index:999;pointer-events:none;font-family:monospace;"></div>
        <div id="info-hint"></div>
        <div id="top-buttons">
            <button class="top-btn" id="btn-pause" title="暂停 (P)">⏸</button>
            <button class="top-btn" id="btn-settings" title="设置">⚙️</button>
            <button class="top-btn" id="btn-inventory" title="背包 (B/I)">🎒</button>
            <button class="top-btn" id="btn-craft" title="制造 (C)">🔨</button>
        </div>
        <div id="toast-container"></div>
        <div id="minimap">
            <canvas id="minimap-canvas"></canvas>
        </div>
        <div aria-hidden="true" id="mining-bar">
            <div class="mb-top">
                <canvas class="mb-icon" height="18" id="mining-icon" width="18"></canvas>
                <div class="mb-name" id="mining-name">挖掘中…</div>
                <div class="mb-percent" id="mining-percent">0%</div>
            </div>
            <div class="mb-track">
                <div class="fill"></div>
            </div>
        </div>
    </div>
    <!-- 移动端控制器 -->
    <div id="mobile-controls">
        <div class="joystick-container" id="joystick">
            <div class="joystick-base"></div>
            <div class="joystick-thumb" id="joystick-thumb"></div>
        </div>
        <div class="jump-container">
            <div class="action-btn jump" id="btn-jump">⬆️</div>
        </div>
        <div class="action-buttons">
            <div class="action-row">
                <div class="action-btn mine" id="btn-mine">⛏️</div>
                <div class="action-btn place" id="btn-place">🧱</div>
            </div>
        </div>
    </div>
    <!-- 十字准心 -->
    <div id="crosshair"></div>

    <!-- ═══════════════════ Core Modules ═══════════════════ -->
    <script src="js/performance/object-pools.js"></script>
    <script src="js/core/event-utils.js"></script>
    <script src="js/performance/texture-cache.js"></script>
    <script src="js/core/dom-utils.js"></script>

    <!-- ═══════════════════ Systems ═══════════════════ -->
    <script src="js/systems/settings.js"></script>
    <script src="js/ui/toast.js"></script>
    <script src="js/systems/fullscreen.js"></script>
    <script src="js/systems/audio.js"></script>
    <script src="js/systems/save.js"></script>
    <script src="js/ui/ux-overlays.js"></script>

    <!-- ═══════════════════ Constants & Data ═══════════════════ -->
    <script src="js/core/constants.js"></script>

    <!-- ═══════════════════ World Generation ═══════════════════ -->
    <script src="js/engine/noise.js"></script>
    <script src="js/engine/world-generator.js"></script>

    <!-- ═══════════════════ Entities ═══════════════════ -->
    <script src="js/entities/particle-system.js"></script>
    <script src="js/entities/dropped-items.js"></script>
    <script src="js/entities/ambient-particles.js"></script>
    <script src="js/entities/player.js"></script>

    <!-- ═══════════════════ Input ═══════════════════ -->
    <script src="js/input/touch-controller.js"></script>

    <!-- ═══════════════════ Engine ═══════════════════ -->
    <script src="js/engine/renderer.js"></script>
    <script src="js/ui/crafting.js"></script>
    <script src="js/systems/quality.js"></script>
    <script src="js/ui/minimap.js"></script>
    <script src="js/ui/inventory.js"></script>
    <script src="js/input/input-manager.js"></script>

    <!-- ═══════════════════ Game Core ═══════════════════ -->
    <script src="js/engine/game-core.js"></script>
    <script src="js/engine/game-systems.js"></script>

    <!-- ═══════════════════ Patches (merged into canonical implementations) ═══════════════════ -->
    <script src="js/engine/render-patches.js"></script>
    <script src="js/systems/weather.js"></script>
    <script src="js/systems/save-enhanced.js"></script>
    <script src="js/systems/structures-biomes.js"></script>
    <script src="js/systems/tile-logic-engine.js"></script>
    <script src="js/workers/worker-client.js"></script>

    <!-- ═══════════════════ Error Handling ═══════════════════ -->
    <script src="js/core/error-guards.js"></script>

    <!-- ═══════════════════ Additional Systems ═══════════════════ -->
    <script src="js/systems/water-physics.js"></script>

    <!-- ═══════════════════ Bootstrap ═══════════════════ -->
    <script src="js/boot/boot.js"></script>
    <script src="js/boot/final-patches.js"></script>
    <script src="js/boot/health-check.js"></script>
</body>

</html>
